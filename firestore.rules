/**
 * @file Firebase Security Rules for Firestore.
 * @description This ruleset enforces a strict user-ownership model for personal journal data.
 *
 * Data Structure:
 * All data is nested under `/users/{userId}`, ensuring clear ownership and simplified security rules.
 * - `/users/{userId}`: User profile information.
 * - `/users/{userId}/journalEntries/{journalEntryId}`: Journal entries for each user.
 * - `/users/{userId}/journalEntries/{journalEntryId}/activities/{activityId}`: Activities within a journal entry.
 * - `/users/{userId}/journalEntries/{journalEntryId}/problemSets/{problemSetId}`: Problem sets within a journal entry.
 *
 * Key Security Decisions:
 * - Strict user ownership: Only the authenticated user can access their own profile and associated journal entries, activities, and problem sets.
 * - Data Denormalization: `userId` is denormalized in subcollections (journalEntries, activities, problemSets) to avoid costly `get()` calls in security rules.
 * - No public listing: Listing of journal entries, activities, and problem sets is restricted to the owner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profiles. Only the authenticated user can access their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile if authenticated as 'user123'.
     * @allow (get) User with ID 'user123' can read their profile if authenticated as 'user123'.
     * @allow (update) User with ID 'user123' can update their profile if authenticated as 'user123'.
     * @allow (delete) User with ID 'user123' can delete their profile if authenticated as 'user123'.
     * @deny (create) User with ID 'user123' cannot create a profile if authenticated as 'user456'.
     * @deny (get) User with ID 'user123' cannot read a profile if authenticated as 'user456'.
     * @deny (update) User with ID 'user123' cannot update a profile if authenticated as 'user456'.
     * @deny (delete) User with ID 'user123' cannot delete a profile if authenticated as 'user456'.
     * @principle Enforces path-based ownership for user profiles.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && isSelfCreate(userId);
      allow get: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
      allow list: if false; // User listing is not permitted.
    }

    /**
     * @description Secures journal entries for each user.
     * @path /users/{userId}/journalEntries/{journalEntryId}
     * @allow (create) User with ID 'user123' can create a journal entry under their profile if authenticated as 'user123'.
     * @allow (get) User with ID 'user123' can read a journal entry under their profile if authenticated as 'user123'.
     * @allow (update) User with ID 'user123' can update a journal entry under their profile if authenticated as 'user123'.
     * @allow (delete) User with ID 'user123' can delete a journal entry under their profile if authenticated as 'user123'.
     * @deny (create) User with ID 'user123' cannot create a journal entry under another user's profile if authenticated as 'user456'.
     * @deny (get) User with ID 'user123' cannot read a journal entry under another user's profile if authenticated as 'user456'.
     * @deny (update) User with ID 'user123' cannot update a journal entry under another user's profile if authenticated as 'user456'.
     * @deny (delete) User with ID 'user123' cannot delete a journal entry under another user's profile if authenticated as 'user456'.
     * @principle Enforces document ownership for journal entries within a user's profile.
     */
    match /users/{userId}/journalEntries/{journalEntryId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Secures activities related to a specific journal entry.
     * @path /users/{userId}/journalEntries/{journalEntryId}/activities/{activityId}
     * @allow (create) User with ID 'user123' can create an activity under their journal entry if authenticated as 'user123'.
     * @allow (get) User with ID 'user123' can read an activity under their journal entry if authenticated as 'user123'.
     * @allow (update) User with ID 'user123' can update an activity under their journal entry if authenticated as 'user123'.
     * @allow (delete) User with ID 'user123' can delete an activity under their journal entry if authenticated as 'user123'.
     * @deny (create) User with ID 'user123' cannot create an activity under another user's journal entry if authenticated as 'user456'.
     * @deny (get) User with ID 'user123' cannot read an activity under another user's journal entry if authenticated as 'user456'.
     * @deny (update) User with ID 'user123' cannot update an activity under another user's journal entry if authenticated as 'user456'.
     * @deny (delete) User with ID 'user123' cannot delete an activity under another user's journal entry if authenticated as 'user456'.
     * @principle Enforces document ownership for activities within a journal entry.
     */
    match /users/{userId}/journalEntries/{journalEntryId}/activities/{activityId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Secures problem sets associated with each journal entry.
     * @path /users/{userId}/journalEntries/{journalEntryId}/problemSets/{problemSetId}
     * @allow (create) User with ID 'user123' can create a problem set under their journal entry if authenticated as 'user123'.
     * @allow (get) User with ID 'user123' can read a problem set under their journal entry if authenticated as 'user123'.
     * @allow (update) User with ID 'user123' can update a problem set under their journal entry if authenticated as 'user123'.
     * @allow (delete) User with ID 'user123' can delete a problem set under their journal entry if authenticated as 'user123'.
     * @deny (create) User with ID 'user123' cannot create a problem set under another user's journal entry if authenticated as 'user456'.
     * @deny (get) User with ID 'user123' cannot read a problem set under another user's journal entry if authenticated as 'user456'.
     * @deny (update) User with ID 'user123' cannot update a problem set under another user's journal entry if authenticated as 'user456'.
     * @deny (delete) User with ID 'user123' cannot delete a problem set under another user's journal entry if authenticated as 'user456'.
     * @principle Enforces document ownership for problem sets within a journal entry.
     */
    match /users/{userId}/journalEntries/{journalEntryId}/problemSets/{problemSetId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  function isSelfCreate(userId) {
      return request.auth.uid == userId;
  }
}